# AI GEO Audit Dashboard

Automated SEO analysis tool for tracking AI-powered search visibility, entity recognition, and SERP behavior.

## Quick Start

### Local Testing
Simply open `audit-dashboard.html` in your browser - no server needed!

## Project Structure & File Organization

**⚠️ IMPORTANT**: When creating new files, place them in the appropriate folders. Only put files in root if absolutely necessary.

### Folder Conventions

- **`Docs/`** - All markdown documentation files (except README.md and HANDOVER.md which stay in root)
- **`scripts/`** - All test, check, debug, and utility JavaScript files
- **`sql/`** - Query and test SQL files (NOT migrations)
- **`migrations/`** - Database migration files (must stay here - referenced by scripts)
- **`api/`** - Vercel serverless functions (must stay here - routing depends on path)
- **`lib/`** - Library and shared utility files
- **`config/`** - Configuration files
- **`test/`** - Test files
- **Root folder** - Only for:
  - `config.js` (required by audit-dashboard.html)
  - `config.example.js` (template file)
  - `audit-dashboard.html` (main application file)
  - `README.md` and `HANDOVER.md` (documentation)
  - Temporary files generated by scripts (e.g., `temp_*.sql`)

### Rules

1. **Never move files from `api/`** - Vercel uses file paths for routing
2. **Never move `config.js`** - Referenced directly by HTML
3. **Never move migration files** - Scripts reference them by path
4. **Always use appropriate folders** - Keep root folder clean

## Deployment

This project is deployed on **Vercel**. See `Docs/DEPLOY.md` for detailed deployment instructions.

### Live Dashboard
The dashboard is available at: `https://ai-geo-audit.vercel.app/`

### Updating the Dashboard

After making changes:
```bash
git add .
git commit -m "Update dashboard"
git push
```

Vercel will automatically rebuild and deploy (usually takes 1-2 minutes).

## Features

- **Optimisation Tracking Module**: Complete keyword optimisation workflow management
  - Create and track optimisation tasks per keyword+URL+type
  - Multiple optimisation cycles with baseline/latest measurements
  - Objective tracking with auto-calculated status (on_track/overdue/met)
  - Performance snapshots showing metric deltas
  - Timeline of events (measurements, notes, cycle changes)
  - Cycle management (start, complete, archive)
  - Read-only share mode for collaboration
  - Comprehensive filtering and status tracking

- **Site AI Health Dashboard**: Comprehensive health score visualization
  - Large speedometer gauge (30% larger) showing AI GEO Score (0-100)
  - Color-coded segments: Red (0-49), Amber (50-69), Green (70-100)
  - Visual needle indicators for AI GEO Score, AI Summary Likelihood, and Brand & Entity
  - RAG status pills with detailed breakdown boxes showing calculation components
  - AI Summary Likelihood indicator (High/Medium/Low) with breakdown
  - Brand & Entity overlay chip showing score and status
- **5 Core Pillars + Overlays**: 
  - **Authority** (30% weight): 4-component model (Behaviour 40%, Ranking 20%, Backlinks 20%, Reviews 20%)
  - **Content/Schema** (25% weight): Foundation schemas, Rich Results, Coverage, Type Diversity
  - **Visibility** (20% weight): Average position and CTR from GSC
  - **Local Entity** (15% weight): NAP consistency, Knowledge Panel, GBP signals
  - **Service Area** (10% weight): Service area coverage and NAP multiplier
  - **Brand & Entity Overlay**: Brand query performance, reviews, entity strength (does not affect AI GEO score)
  - **AI Summary Likelihood**: Composite score for AI/Google answer accuracy (snippet readiness, visibility, brand)
- **Real-time Data Sources**: 
  - Google Search Console API (OAuth2) - clicks, impressions, position, queries, brand queries
  - Google Business Profile API - ratings, reviews, locations, service areas, NAP data
  - Schema Audit - Full site crawl for JSON-LD markup validation
  - Backlink CSV Upload - Domain rating, referring domains, follow ratio
  - Trustpilot Reviews - Snapshot integration for review aggregation
- **Visual Dashboards**: 
  - Site AI Health speedometer with multiple score indicators
  - Radar chart with RAG color-coded score labels
  - Trend graphs showing historical performance for all 6 metrics (5 pillars + Brand & Entity)
  - Snippet Readiness nested doughnut chart with weighted segments
  - Pillar Scorecard table with detailed descriptions and improvement suggestions
  - Brand queries mini-table showing top branded queries with CTR/position
- **Historical Tracking**: 
  - Supabase integration for all pillars (not just Content/Schema)
  - Trend charts with segmented Authority data (All pages, Exclude education, Money pages only)
  - Brand & Entity fallback calculation from GSC for historical dates
- **Shareable Audit Links**: 
  - Generate shareable URLs with 30-day expiration
  - View complete audit results without running an audit
  - Perfect for client demos and team sharing
- **Dashboard Features**:
  - Automatic persistence (localStorage) - loads last audit on page reload
  - Retry failed URLs functionality
  - Page segmentation with segment-aware metrics
  - Collapsible CSV upload sections
  - Detailed calculation explanations
  - RAG status badges with tooltips

## Setup

1. **Configure OAuth2 Credentials** (see `GSC_API_SETUP.md` for detailed instructions):
   - Enable Google Search Console API in Google Cloud Console
   - Create OAuth2 credentials (Client ID and Client Secret)
   - Generate a refresh token
   - Add credentials to Vercel environment variables

2. **Access the Dashboard**:
   - Open the live dashboard at `https://ai-geo-audit.vercel.app/`
   - Enter your property URL (e.g., `https://alanranger.com`)
   - Click "Run Audit Scan"

## Current Status

**⚠️ NOTE**: For current known issues and fix status (as of 2026-01-10), see **`HANDOVER.md`**.

**Latest Update (2026-01-16)**:
- ✅ Schema totals derived from pages detail on save/read (prevents zero coverage on refresh)
- ✅ Partial saves no longer overwrite schema metadata (`schema_types`, `schema_rich_eligible`, totals)
- ✅ Authority trend skips partial audits (prevents end-of-line dips)
- ✅ Score Trends respect selected date range (timeseries now honors start/end params)
- ✅ Local signals + schema totals now persist across refresh after global run

- ✅ **Fully Implemented**: All core features are production-ready
- ✅ **Site AI Health Dashboard**: Speedometer with multiple score indicators, RAG pills with breakdown boxes
- ✅ **5 Core Pillars**: All pillars fully implemented with real data sources
- ✅ **Brand & Entity Overlay**: Brand query classification, metrics calculation, trend tracking
- ✅ **AI Summary Likelihood**: Composite scoring with snippet readiness, visibility, and brand signals
- ✅ **Google Search Console API**: Full OAuth2 integration with brand query detection
- ✅ **Schema Audit**: Complete site crawl with coverage, diversity, and rich result eligibility
- ✅ **Backlink Analysis**: CSV upload support with domain rating and metrics
- ✅ **Review Aggregation**: Trustpilot snapshot + Google Business Profile reviews
- ✅ **Local Entity Tracking**: Knowledge panel detection, NAP consistency, GBP integration
- ✅ **Historical Tracking**: Supabase integration for all pillars with trend charts
- ✅ **Shareable Links**: Public sharing with 30-day expiration
- ✅ **Page Segmentation**: Segment-aware metrics (All pages, Exclude education, Money pages only)
- ✅ **Dashboard Persistence**: Automatic localStorage saving and loading
- ✅ **Retry Mechanism**: Rescan failed URLs without full audit
- ✅ **Intent-Based Keyword Segmentation**: Keyword classification based on search intent (Brand → Money → Education → Other)
- ✅ **Data-Driven Presets**: Refactored preset system with hard reset and single source of truth
- ✅ **Ranking & AI Visibility**: Keyword rankings with AI Overview citations, competitor analysis, and domain strength integration
- ✅ **AI citations attribution by cited URLs**:
  - Portfolio monthly KPIs and the Ranking & AI “Money citations” tile attribute AI citations to segments using the **cited URL list** (`ai_alan_citations`) rather than `best_url`
  - Any “unattributed delta” (when `ai_alan_citations_count` exceeds captured URL items) is rolled into **Other (non‑money)** so segment totals reconcile to site totals
- ✅ **Portfolio segmentation**:
  - Segments include **Academy** (single URL `/free-online-photography-course`) and **Other (non‑money)** so segment totals reconcile to Entire site
  - Segment label modal supports Segment pages + AI‑cited pages with copy list
- ✅ **Domain Strength Tracking**: Domain rank snapshots with competitor flags and domain type classification
- ✅ **Keyword Management**: Edit Keywords modal for managing keyword list with data loss warnings
- ✅ **Money Pages Performance Tracking**: Split trend charts, KPI tracker (last 28 days with 8 weekly data points), and priority actions with accurate CTR plotting. Uses actual GSC timeseries data calculated from `gsc_timeseries` table.
- ✅ **Money Pages Suggested Top 10**: Card-based panel showing top priority pages for optimization with impact/difficulty scoring, optimization status tracking, and direct task creation.
- ✅ **Audit guardrails**:
  - “Run Audit Scan” will not overwrite Portfolio AI fields with zeros if no Ranking & AI data exists for the date (common with GSC lag)
  - Bulk “Update All Tasks with Latest Data” warns if Ranking & AI snapshot is missing/stale, and does not require Ranking & AI for URL‑only tasks
- ✅ **GAIO Branding**: Updated throughout UI from "AIO" to "GAIO (Generative AI Optimization)"

## API Endpoints

The following serverless functions are available:

- `/api/fetch-search-console` - Fetch GSC performance data (legacy)
- `/api/schema-audit` - Scan URLs for JSON-LD schema coverage
- `/api/aigeo/gsc-entity-metrics` - Comprehensive GSC entity metrics with brand query classification
- `/api/aigeo/schema-coverage` - Schema coverage analysis
- `/api/aigeo/serp-features` - SERP feature detection
- `/api/aigeo/local-signals` - Google Business Profile data (GBP rating, reviews, NAP consistency, service areas)
- `/api/aigeo/backlink-metrics` - Backlink metrics (referring domains, total backlinks, follow ratio)
- `/api/reviews/site-reviews` - On-site/Trustpilot review data
- `/api/aigeo/entity-extract` - Entity extraction (stub)
- `/api/supabase/save-audit` - Save audit results to Supabase (includes brand_overlay, ai_summary)
- `/api/supabase/get-audit-history` - Fetch historical audit data for all pillars
- `/api/supabase/create-shared-audit` - Create shareable audit link
- `/api/supabase/get-shared-audit` - Retrieve shared audit by ID
- `/api/keywords/get` - Fetch current keyword list from latest audit
- `/api/keywords/save` - Save updated keyword list to latest audit
- `/api/aigeo/serp-rank-test` - Test SERP ranking for a single keyword
- `/api/aigeo/ai-mode-serp-batch-test` - Batch test keywords for AI Overview citations and rankings
- `/api/domain-strength/overview` - Fetch domain strength overview and domain list
- `/api/domain-strength/update-domain` - Update domain type and competitor flag

## Planned Features

### Money Pages Performance & Actions
A dedicated section tracking money pages performance vs the rest of the site, with URL-level opportunity identification and actionable recommendations. See `MONEY_PAGES_PERFORMANCE.md` for full specification.

**Implementation Phases:**
- Phase 1: Data model + calculations (money-segment aggregates, opportunity flags) ✅
- Phase 2: UI block (summary strip, charts, KPIs, opportunity table) ✅
- Phase 3: Recommendation text engine (dynamic action suggestions) ✅
- Phase 4: Priority Matrix & Actions integration (impact/difficulty scoring, Suggested Top 10 panel) ✅

### Other Planned Enhancements
- [ ] Real-time SERP feature monitoring and alerts
- [ ] Advanced backlink analysis with automated discovery
- [ ] Competitive analysis and benchmarking
- [ ] Automated action recommendations engine
- [ ] Export capabilities (PDF, CSV reports)
- [ ] Google Analytics integration
- [ ] Automated scheduling (cron jobs)
- [ ] Email notifications

## Notes

- **Authentication**: OAuth2 credentials stored securely in Vercel environment variables
- **API Architecture**: All API calls handled server-side via Vercel serverless functions
- **Visualizations**: Chart.js (CDN) with custom plugins for speedometer, radar, trend charts
- **Data Sources**: 
  - Schema audit reads from GitHub-hosted CSV or manual URL lists
  - Historical data stored in Supabase (requires `SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY`)
  - Brand queries classified using configurable brand terms list
- **Scoring Formulas**:
  - **AI GEO Score**: Weighted average of 5 pillars (Authority 30%, Content/Schema 25%, Visibility 20%, Local Entity 15%, Service Area 10%)
  - **AI Summary Likelihood**: Snippet Readiness (50%), Visibility (30%), Brand Score (20%) - thresholds: Low <50, Medium 50-69, High ≥70
  - **Brand Overlay**: Brand Search (40%) + Reviews (30%) + Entity (30%) - thresholds: Weak <40, Developing 40-69, Strong ≥70
  - **Snippet Readiness**: Content/Schema (40%), Visibility (35%), Authority (25%)
  - **Content/Schema**: Foundation (30%), Rich Results (35%), Coverage (20%), Diversity (15%)
  - **Authority**: Behaviour (40%), Ranking (20%), Backlinks (20%), Reviews (20%)
    - Behaviour: CTR for ranking queries (position ≤ 20) + top-10 CTR
    - Ranking: Impression-weighted average position + top-10 impression share
    - Backlinks: Referring domains (100+ = max) + follow ratio (from CSV upload)
    - Reviews: Combined GBP and on-site ratings/counts (60% GBP, 40% site)
- **RAG Thresholds**: Red (0-49), Amber (50-69), Green (70-100) - consistent across all scores
- **Dashboard State**: Persists in browser localStorage between sessions
- **Shareable Links**: Valid for 30 days, stored in Supabase `shared_audits` table
- **Keyword Segmentation**: Intent-based classification (Brand → Money → Education → Other) with confidence scoring
  - Brand: matches brand terms (alan ranger, alanranger, photography academy, etc.)
  - Money: transactional terms (lessons, courses, workshops, etc.) OR local modifiers (near me, coventry, etc.) OR postcode patterns
  - Education: informational terms (how to, guide, tutorial, etc.) OR technique topics (aperture, shutter speed, etc.)
  - Other: default fallback for unclassified keywords
- **Preset System**: Data-driven presets with hard reset (no filter stacking)
  - All keywords, High-impact money, AI Overview not cited, Brand safety, Blog opportunities, Local visibility

