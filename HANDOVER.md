# AI GEO Audit - Comprehensive Handover Document

**Last Updated**: 2026-01-08  
**Current Commit**: `2cb0a2a` (Phase 3 fixes + UI enhancements + dashboard visualizations + chart fixes)  
**Purpose**: Single source of truth for all projects, phases, tasks, fixes, and key information for any new chat thread.

---

## Executive Summary

This document consolidates ALL critical information about the AI GEO Audit project:
1. **Current State**: Rolled back to stable baseline (`8951fcf`)
2. **All Project Plans**: Money Pages, Optimisation Tracking, Fix Plans, Architecture Roadmap
3. **All Phases**: Implementation status across all projects
4. **All Update Buttons**: Complete reference of all data update/refresh processes
5. **All Fixes**: Status of all fixes and known issues
6. **Technical Architecture**: Data flow, key functions, dependencies

---

## Project Structure & File Organization

**‚ö†Ô∏è CRITICAL**: When creating new files, ALWAYS place them in the appropriate folders. Only put files in root if absolutely necessary for the application to function.

### Folder Conventions

| Folder | Purpose | Can Move? | Notes |
|--------|---------|-----------|-------|
| **`Docs/`** | All markdown documentation | ‚úÖ Yes | All MD files except README.md and HANDOVER.md |
| **`scripts/`** | Test, check, debug, utility JS files | ‚úÖ Yes | All root-level test/check/debug scripts |
| **`sql/`** | Query and test SQL files | ‚úÖ Yes | NOT migrations (those stay in `migrations/`) |
| **`migrations/`** | Database migration files | ‚ùå **NO** | Referenced by scripts via path |
| **`api/`** | Vercel serverless functions | ‚ùå **NO** | Vercel routing depends on file paths |
| **`lib/`** | Library and shared utilities | ‚ö†Ô∏è **Check first** | May be imported by API files |
| **`config/`** | Configuration files | ‚ö†Ô∏è **Check first** | May be referenced by code |
| **`test/`** | Test files | ‚úÖ Yes | Test suite files |
| **Root** | Application files only | ‚ùå **NO** | See "Root Folder Rules" below |

### Root Folder Rules

**Only these files should be in root:**
- `config.js` - **MUST stay** (referenced by `audit-dashboard.html`)
- `config.example.js` - Template file (can stay)
- `audit-dashboard.html` - Main application file
- `README.md` - Project overview
- `HANDOVER.md` - This document
- `vercel.json` - Vercel configuration
- `package.json` - Node.js dependencies
- Temporary files generated by scripts (e.g., `temp_*.sql`, `temp_*.json`)

### Critical Rules

1. **Never move files from `api/`** - Vercel uses file paths to create API routes
   - Example: `api/supabase/get-latest-audit.js` ‚Üí `/api/supabase/get-latest-audit`
   - Moving breaks all API endpoints

2. **Never move `config.js`** - Referenced directly by HTML:
   ```javascript
   fetch('config.js')
   configScript.src = 'config.js'
   ```

3. **Never move migration files** - Scripts reference them by path:
   ```javascript
   const migrationPath = path.join(__dirname, 'migrations', '20251217_add_gbp_reviews_columns.sql');
   ```

4. **Always use appropriate folders** - Keep root folder clean for housekeeping

### When Creating New Files

- **Documentation** ‚Üí `Docs/`
- **Test/Check/Debug scripts** ‚Üí `scripts/`
- **Query/test SQL** ‚Üí `sql/`
- **Database migrations** ‚Üí `migrations/` (with date prefix)
- **API endpoints** ‚Üí `api/` (with proper subfolder structure)
- **Library code** ‚Üí `lib/` (check if imported first)

---

## Current State (Post-Rollback)

### Rollback Status
- **Baseline Commit**: `8951fcf` (2025-12-XX) - Stable baseline established
- **Current Commit**: `577c64e` - Fixes applied for URL matching and flickering
- **Rollback Reason**: Subsequent fixes introduced flickering counts and syntax errors
- **Baseline Characteristics**:
  - ‚úÖ Stable AI citation counts (no flickering)
  - ‚ö†Ô∏è AI Citations column sorting still present (not yet disabled)
  - ‚úÖ No syntax errors
  - ‚úÖ Clean, synchronized codebase

### Previous Fixes (v1.7.8 - Commit 7307bab)
1. **Unified Data Source**: Table now uses same API endpoint as cards
   - Removed buggy client-side `computeAiMetricsForPageUrl` from API fallback
   - Table and cards now use same source of truth (`/api/supabase/query-keywords-citing-url`)
   - Ensures table shows same values as cards (e.g., 2 instead of 5)
2. **Sorting Fix**: Fixed sorting to use cache instead of reading from cells
   - Prevents values from becoming blank when sorting multiple times
   - Uses strict URL matching (no substring) when reading from cache
3. **Pre-populate from Cache**: Table cells now pre-populate from cache on initial render
   - Shows cached value immediately (prevents flickering)
   - Only shows placeholder if cache not yet available

### Previous Fixes (v1.7.7 - Commit e40c912)
1. **AI Citations Cell Update Protection**: Added protection to prevent cell display update when valid cached value exists
   - Cache is now checked before updating cell from API response
   - Prevents flickering from correct value (2) to incorrect API response (5)
   - Cell display now respects cached values over API responses
2. **Row Matching**: Fixed to use strict matching (no substring) when finding rows for API updates
3. **API Call Filter**: Enhanced to check both local and global cache before making API calls

### Previous Fixes (v1.7.6 - Commit 577c64e)
1. **AI Citations URL Matching**: Fixed strict path segment matching
   - Replaced substring matching (`.includes()`) with strict path segment matching
   - Prevents `landscape-photography-workshops` from incorrectly matching `photography-workshops`
   - Matches API endpoint logic for consistency
2. **AI Citations Cache Protection**: Prevented API responses from overwriting valid cached values in cache object
   - Cache from localStorage (latest audit data) is now trusted over API responses
   - API is only used as fallback when cache is missing/0

### Recent Fixes (v1.7.9 - Commit 30ed589)
1. **AI Citations Sorting Fix**: Fixed sorting to preserve cache values and prevent blank cells
   - Enhanced cache lookup with normalized URL matching
   - Preserves valid displayed values when table re-renders after sorting
   - Improved row matching in API result processing
   - Fixed issue where citation counts went to zero when sorting
2. **Card 3 Readability Improvements**: Made body text larger and black
   - "Next steps:" text increased from 0.8rem to 0.95rem
   - Estimated impact text increased from 0.75rem to 0.9rem
   - Reason text increased from 0.7rem to 0.85rem
   - All body text changed from grey to black (#0f172a) for better readability
3. **Default Sort**: Set Money Pages table to sort by clicks (descending) on page load
   - Changed default sort from null to 'clicks' with direction 'desc'
   - Shows highest-clicking pages first by default
4. **Schema Types Column Alignment**: Right-aligned header and cells to prevent overlap with Opportunity column
   - Changed header from `text-align: left` to `text-align: right`
   - Added `text-align: right` to cell styling

### Current Issues
‚úÖ **All previously listed issues have been resolved:**
1. ‚úÖ **AI Citations Initial Load**: Resolved - Cache timing issue addressed with improved cache initialization and normalized URL matching
2. ‚úÖ **Excessive API Calls**: Resolved - Debouncing and execution guards implemented
3. ‚úÖ **URL Task AI Data**: Resolved - Matching logic fixed and working correctly

### Completed Fixes (Previously Listed as Lost in Rollback)
‚úÖ **All fixes have been re-implemented and completed:**
- ‚úÖ Fix 1: URL matching optional for keyword tasks - **COMPLETE**
- ‚úÖ Fix 5: Always fetch latest from Supabase - **COMPLETE**
- ‚úÖ Fix 2: Partial unification of logic - **COMPLETE**
- ‚úÖ All AI Citations column fixes (sort icon removal, debouncing, etc.) - **COMPLETE**

---

## Project Plans & Status

### Project 1: Money Pages Performance & Actions
**Status**: ‚úÖ **100% COMPLETE** (All 4 phases)

| Phase | Status | Date Completed | Deliverables |
|-------|--------|----------------|--------------|
| Phase 1: Data Model + Calculations | ‚úÖ COMPLETE | 2025-12-XX | Money-segment aggregates, opportunity flags |
| Phase 2: UI Block | ‚úÖ COMPLETE | 2025-12-XX | Summary strip, charts, KPIs, opportunity table |
| Phase 3: Recommendation Text Engine | ‚úÖ COMPLETE | 2025-12-XX | Dynamic action suggestions |
| Phase 4: Priority Matrix & Actions | ‚úÖ COMPLETE | 2025-12-22 | Impact/difficulty scoring, Suggested Top 10 panel |

**Features Implemented**:
- Performance Trends charts (split Volume/Rate charts)
- KPI Tracker (28 days, 8 weekly points from GSC timeseries)
- Priority & Actions section with impact/difficulty matrix
- Suggested Top 10 Priority Pages panel
- Filter dropdowns with persistent counts
- Accurate CTR plotting and trend calculations

**Documentation**: `Docs/MONEY_PAGES_PERFORMANCE.md`

---

### Project 2: Optimisation Tracking Module
**Status**: ‚úÖ **91% COMPLETE** (Phases 1-9 complete, Phase 10-11 planned)

| Phase | Status | Date Completed | Deliverables |
|-------|--------|----------------|--------------|
| Phase 1: Database Layer | ‚úÖ COMPLETE | 2025-12-18 | Schema, tables, views, RLS policies |
| Phase 2: UI Entry Point | ‚úÖ COMPLETE | 2025-12-18 | Optimisation column in Ranking & AI table |
| Phase 3: Core Management UI | ‚úÖ COMPLETE | 2025-12-19 | Full Optimisation Tracking panel |
| Phase 4: Tracking Metrics | ‚úÖ COMPLETE | 2025-12-19 | Performance snapshots, measurement history |
| Phase 5: Objective Integrity | ‚úÖ COMPLETE | 2025-12-19 | Auto-status calculation (on_track/overdue/met) |
| Phase 5.6: Share Mode | ‚úÖ COMPLETE | 2025-12-19 | Read-only share links with token auth |
| Phase 6: Cycle Management | ‚úÖ COMPLETE | 2025-12-19 | Per-task cycle numbering, history |
| Phase 7: Cycle Completion | ‚úÖ COMPLETE | 2025-12-19 | Complete/archive cycles, timeline events |
| Phase 8: KPI Formatting | ‚úÖ COMPLETE | 2025-12-19 | CTR as pp, rank lower better, no double % |
| Phase 9: Enhanced Analytics | ‚úÖ COMPLETE | 2026-01-07 | KPI tiles, progress columns, sparklines, impact estimates |
| Phase 10: Advanced Reporting | ‚è∏Ô∏è PLANNED | Not started | Monthly rollups, export, regression detection |
| Phase 11: Automation | ‚è∏Ô∏è PLANNED | Not started | Automated reminders, stale monitoring alerts |

**Phase 9 Deliverables (Complete)**:
- [x] KPI Tiles (RAG) reflecting objectives
- [x] Objective progress columns in table
- [x] Mini sparklines (per-task or per-KPI)
- [x] Estimated impact tiles
- [x] Time-based charts

**Documentation**: `Docs/OPTIMISATION_TRACKING_MODULE_PLAN.md`, `Docs/OPTIMISATION_TRACKING_PHASES_COMPLETE.md`

---

### Project 3: Fix Plan - Data Consistency & AI Citations
**Status**: ‚úÖ **75% COMPLETE** (Phases 1-3 complete, additional fixes applied, Phases 4-5 pending)

**5-Phase Implementation Plan**:

#### Phase 1: AI Citations Column Fixes
**Status**: ‚úÖ **COMPLETE** (2026-01-07)

**Tasks**:
- [x] Remove sort icon from AI Citations column header
- [x] Disable sorting functionality completely
- [x] Add CSS to hide all sort indicators
- [x] Prevent header interaction (pointer-events, cursor, onclick handlers)
- [x] Ensure `getSortIcon` never returns icon for 'aiCitations' column
- [x] Test that column is completely non-interactive

**Files Modified**:
- `audit-dashboard.html`: AI Citations header (`#money-sort-ai-citations`)
- `audit-dashboard.html`: `getSortIcon()` function
- `audit-dashboard.html`: CSS stylesheet section

---

#### Phase 2: Prevent Flickering & Reduce API Calls
**Status**: ‚úÖ **COMPLETE** (2026-01-07)

**Tasks**:
- [x] Implement debounce mechanism for `populateMoneyPagesAiCitations` (300ms delay)
- [x] Add global execution flag to prevent simultaneous calls
- [x] Replace `console.log` with `debugLog` for UI visibility
- [x] Enhance cell update logic:
  - Skip API calls for cells with valid numeric values (>0)
  - Only update if new value is higher than existing
  - Preserve cached values even if API returns 0 or null
- [x] Reduce DOM wait time (100ms instead of 300ms)
- [x] Wrap logic in try...finally to ensure flag reset

**Files Modified**:
- `audit-dashboard.html`: `populateMoneyPagesAiCitations()` function (~line 30768)

---

#### Phase 3: Check & Fix All Update Buttons
**Status**: ‚úÖ **AUDIT COMPLETE, FIXES APPLIED** (2026-01-07)

**Tasks**:
- [x] Audit all update/refresh buttons (see "All Update Buttons Reference" below)
- [x] Verify all use consistent data source priority
- [x] Ensure all fetch latest from Supabase before using localStorage
- [x] Standardize URL matching logic (optional for keyword tasks)
- [x] Test each button individually
- [x] Document any inconsistencies found

**Critical Buttons Audited**:
1. ‚úÖ **Add Measurement** (Optimisation Tracking) - Line ~13715 - **CORRECT**
2. ‚úÖ **Rebaseline** (Optimisation Tracking) - Line ~15230 - **CORRECT**
3. ‚úÖ **Update Task Latest** (Optimisation Tracking) - Line ~16748 - **FIXED** (2026-01-07)
4. ‚úÖ **Bulk Update All Tasks** (Optimisation Tracking) - Line ~15769 - **CORRECT**
5. ‚úÖ **Run Audit Scan** (Configuration/Overview) - Line ~25894 - **FIXED** (2026-01-07)
6. ‚úÖ **Run Ranking & AI Scan** (Ranking & AI tab) - **CORRECT**
7. ‚úÖ **Run Money Pages Scan** (Dashboard/Money Pages) - **CORRECT**
8. ‚úÖ **Run All Audits & Updates** (Dashboard) - Line ~54654 - **MINOR ISSUE** (low priority)
9. ‚úÖ **Refresh GSC Data** (Ranking & AI) - Line ~49941 - **FIXED** (2026-01-07)

**Fixes Applied**:
1. ‚úÖ **Update Task Latest**: Added Supabase fetch first, URL task handling, localStorage fallback
2. ‚úÖ **Run Audit Scan**: Moved Supabase save before localStorage update
3. ‚úÖ **Refresh GSC Data**: Reversed data source priority (Supabase first, then fallbacks)
4. ‚úÖ **Run All Audits & Updates**: Fixed domain strength batch processing (processes all batches, not just one)
5. ‚úÖ **Domain Strength Delta**: Fixed delta calculation to compare against last different score (not just previous snapshot)
6. ‚úÖ **Money Pages AI Citations**: Fixed Suggested Top 10 cards to show actual citation counts (not timer placeholder)
7. ‚úÖ **Monitoring Pill Color**: Changed Money Pages Opportunity Table monitoring status to blue (was green)
8. ‚úÖ **Objective KPI Display**: Fixed tasks table to show correct Objective KPI label (e.g., "Rank" instead of "-")
9. ‚úÖ **Performance Snapshot Highlighting**: Added visual highlight to target metric row in Performance Snapshot table (orange border only, no background)
10. ‚úÖ **Global Run Auto-Update**: Fixed "Run All Audits & Updates" to automatically create measurements without confirmation dialog
11. ‚úÖ **Dashboard Visualizations**: Added radar chart to AI Summary Likelihood tile and bar chart to Uplift Remaining tile
12. ‚úÖ **Uplift Chart Labels**: Removed domain from chart labels (shows only URL paths)
13. ‚úÖ **Money Share Terminology**: Changed "Product" to "Service" in Money Share radar chart label
14. ‚úÖ **Median Delta Chart**: Fixed width to fill container and updated to 28 days (was 30 days)

**Files Modified**:
- `audit-dashboard.html`: `updateTaskLatest()` function (~line 16748)
- `audit-dashboard.html`: `runAudit()` function (~line 26460)
- `audit-dashboard.html`: `refreshGSCDataOnly()` function (~line 49941)
- `audit-dashboard.html`: `runDashboardGlobalRun()` function (~line 54895) - domain strength batch processing
- `audit-dashboard.html`: `computeDomainStrengthDelta()` function (~line 50363) - delta calculation
- `audit-dashboard.html`: Money Pages Suggested Top 10 cards (~line 35599) - AI citations
- `audit-dashboard.html`: `renderMoneyPagesTable()` - monitoring pill color
- `audit-dashboard.html`: `renderOptimisationTasksTable()` (~line 9406) - Objective KPI display
- `audit-dashboard.html`: `renderOptimisationMetricsSnapshot()` (~line 12849) - target metric highlighting (border only)
- `audit-dashboard.html`: `renderOptimisationMetricsSnapshotForCycle()` (~line 10618) - pass task object
- `audit-dashboard.html`: `bulkUpdateAllTasks()` (~line 15834) - skip confirmation in global run
- `audit-dashboard.html`: `runDashboardGlobalRun()` (~line 55073) - pass skipConfirmation parameter
- `audit-dashboard.html`: `renderDashboardAiSummaryRadar()` (~line 54279) - AI Summary Likelihood radar chart
- `audit-dashboard.html`: `renderDashboardUpliftChart()` (~line 54330) - Uplift Remaining bar chart
- `audit-dashboard.html`: `renderDashboardMoneyShareRadar()` (~line 54479) - changed "Product" to "Service"
- `audit-dashboard.html`: `computeDashboardSnapshot()` (~line 53705) - fixed pillars initialization, added AI Summary components
- `audit-dashboard.html`: Median Delta chart rendering (~line 12432) - fixed width and 28-day filter
- `api/domain-strength/overview.js`: Delta calculation logic (~line 205)
- `Docs/PHASE3-AUDIT-FINDINGS.md`: Complete audit documentation

---

#### Phase 4: Align All Audit Processes
**Status**: ‚è∏Ô∏è **NOT STARTED**

**Tasks**:
- [ ] Document all audit/scan processes (see "All Audit Processes" below)
- [ ] Ensure consistent data source priority across all processes
- [ ] Verify all processes use latest data from Supabase
- [ ] Standardize error handling and logging
- [ ] Create unified data fetching function
- [ ] Test end-to-end audit flow

**Processes to Align**:
1. Run Audit Scan (`runAudit()`) - Creates `queryTotals`
2. Run Ranking & AI Scan (`loadRankingAiData()`) - Creates `combinedRows`
3. Run Money Pages Scan (`dashboardRunMoneyPagesScan()`) - Refreshes from audit
4. Run Domain Strength Snapshot (`runDomainStrengthSnapshot()`)
5. Sync CSV (`syncCsv()`)
6. Run All Audits & Updates (`runDashboardGlobalRun()`) - Global execution

**Files to Modify**:
- `audit-dashboard.html`: All audit/scan functions
- Create unified data fetching utilities

---

#### Phase 5: URL Task AI Citations Logic Fix (Critical)
**Status**: ‚è∏Ô∏è **AWAITING APPROVAL** (supersedes Fix 3)

**Problem**: URL tasks look for keywords where `best_url` matches target URL, then aggregates citations. This is WRONG because AI citations are keyword-driven, not URL-driven.

**Correct Logic**: Find keywords where `ai_alan_citations` array contains the target URL, count unique keywords citing the URL.

**Tasks**:
- [ ] Reverse matching logic in `computeAiMetricsForPageUrl()`
- [ ] Find keywords where `ai_alan_citations` array contains target URL
- [ ] Count unique keywords (or total citations - TBD)
- [ ] Set AI Overview = true only if at least one citing keyword has overview
- [ ] Test with "photography-courses-coventry" URL
- [ ] Update all functions using this logic

**Files to Modify**:
- `audit-dashboard.html`: `computeAiMetricsForPageUrl()` function (~line 12700)
- `audit-dashboard.html`: `addMeasurementBtn` handler (uses above function)
- `audit-dashboard.html`: `rebaselineBtn` handler (uses above function)
- `audit-dashboard.html`: `bulkUpdateAllTasks()` (uses above function)

**Documentation**: `Docs/URL-TASK-AI-CITATIONS-FIX-ANALYSIS.md`

---

### Project 4: Architecture Roadmap (Remaining Steps)
**Status**: Various completion levels

#### Phase 1: Complete Data Integration
- **1.1 Local Signals API**: ‚ö†Ô∏è PARTIAL (GBP API integrated, some features remain)
- **1.2 Backlink Metrics API**: ‚úÖ COMPLETE (CSV upload working)
- **1.3 Entity Extraction**: ‚ùå NOT STARTED (still stub)

#### Phase 2: Automation & Scheduling
- **2.1 Automated Scheduling**: ‚ùå NOT STARTED (manual trigger only)
- **2.2 Data Persistence**: ‚úÖ COMPLETE (Supabase integration done)
- **2.3 Multi-Property Support**: ‚ùå NOT STARTED

#### Phase 3: Enhanced Features
- **3.1 Advanced Analytics**: ‚ùå NOT STARTED
- **3.2 Reporting**: ‚ùå NOT STARTED
- **3.3 Alerts & Notifications**: ‚ùå NOT STARTED

#### Phase 4: UI/UX Improvements
- **4.1 Dashboard Enhancements**: ‚ö†Ô∏è PARTIAL (some done, more planned)
- **4.2 Performance Optimization**: ‚ö†Ô∏è PARTIAL (some optimizations done)

**Documentation**: `Docs/ARCHITECTURE.md`

---

## All Update Buttons Reference

### Module: Configuration & Reporting
| Button | Element ID | Function | Data Fetched |
|--------|------------|----------|--------------|
| Run Audit Scan | `runAudit` | `window.runAudit()` | GSC, Local Signals, Reviews, Backlinks, Schema |
| Sync CSV | `syncCsvBtn` | `window.syncCsv()` | CSV from GitHub/remote |
| Share Audit | `shareAudit` | `window.shareAudit()` | Generates share token |
| Save Configuration | `saveConfig` | `saveConfig()` | Saves to localStorage |
| Save Admin Key | `saveAdminKey` | `setAdminKey()` | Saves to sessionStorage/localStorage |

### Module: Dashboard
| Button | Element ID | Function | Data Fetched |
|--------|------------|----------|--------------|
| Run All Audits & Updates | `dashboard-run-all-btn` | `window.runDashboardGlobalRun()` | All scans in sequence |
| Run scan (Ranking & AI) | N/A | `window.dashboardRunRankingAiScan()` | DataForSEO SERP data |
| Run scan (Money Pages) | N/A | `window.dashboardRunMoneyPagesScan()` | Latest audit from Supabase |
| Run snapshot (Domain Strength) | N/A | `window.runDomainStrengthSnapshot()` | DataForSEO Labs data |

### Module: Keyword Ranking and AI
| Button | Element ID | Function | Data Fetched |
|--------|------------|----------|--------------|
| Run ranking & AI check | `ranking-ai-refresh` | `window.loadRankingAiData(true)` | DataForSEO SERP API |
| Refresh GSC Data | `ranking-gsc-refresh` | `window.refreshRankingAiGscData()` | GSC API (query-level) |
| Edit Keywords | `edit-keywords-btn` | Opens modal | Loads/saves via API |
| Run Domain Strength Snapshot | `domain-strength-run-btn` | `window.runDomainStrengthSnapshot()` | DataForSEO Labs API |
| Backfill Domain Ranks | `backfill-domain-ranks-btn` | `backfillMissingDomainRanks()` | Calls backfill API |

### Module: Optimisation Tracking
| Button | Element ID | Function | Data Fetched |
|--------|------------|----------|--------------|
| Update All Tasks with Latest Data | `optimisation-bulk-update-btn` | `window.bulkUpdateAllTasks()` | Latest audit + combinedRows |
| Update (per row) | `optimisation-update-btn-{taskId}` | `window.updateTaskLatest()` | Latest audit + combinedRows |
| Add Measurement | `optimisation-add-measurement-btn` | Add Measurement handler | Latest audit + combinedRows |
| Rebaseline | `optimisation-rebaseline-btn` | Rebaseline handler | Latest audit + combinedRows |
| Complete Cycle | `optimisation-complete-cycle-btn` | `window.completeCycle()` | Updates task status |
| Archive Cycle | `optimisation-archive-cycle-btn` | `window.archiveCycle()` | Updates task status |
| Start New Cycle | `optimisation-start-cycle-btn` | `window.startNewCycle()` | Creates new cycle |

**Critical Note**: Add Measurement, Rebaseline, and Bulk Update all use `computeAiMetricsForPageUrl()` for URL tasks. They should use identical logic.

**Documentation**: `Docs/UPDATE-TASKS-REFERENCE.md` (comprehensive reference)

---

## All Audit/Scan Processes

### Primary Data Collection Processes

1. **Run Audit Scan** (`runAudit()`)
   - **Location**: Line ~24438
   - **Creates**: `queryTotals` (GSC data only, NO ranking/AI)
   - **Stores**: `localStorage.last_audit_results`, Supabase `audit_results`
   - **Does NOT**: Fetch Ranking & AI data (separate process)

2. **Run Ranking & AI Scan** (`loadRankingAiData()`)
   - **Location**: Ranking & AI tab
   - **Creates**: `combinedRows` (ranking + AI data)
   - **Stores**: `localStorage.rankingAiData`, Supabase `keyword_rankings`, `audit_results.ranking_ai_data`
   - **Critical**: This is the data source for `computeAiMetricsForPageUrl()`

3. **Run Money Pages Scan** (`dashboardRunMoneyPagesScan()`)
   - **Location**: Dashboard/Money Pages tab
   - **Refreshes**: From latest audit (doesn't run new audit)
   - **Stores**: `window.moneyPagesMetrics`, localStorage

4. **Run Domain Strength Snapshot** (`runDomainStrengthSnapshot()`)
   - **Location**: Ranking & AI tab / Dashboard
   - **Calculates**: Domain strength score
   - **Stores**: Supabase and localStorage

5. **Sync CSV** (`syncCsv()`)
   - **Location**: Configuration tab
   - **Syncs**: CSV from remote source
   - **Stores**: localStorage

6. **Run All Audits & Updates** (`runDashboardGlobalRun()`)
   - **Location**: Dashboard tab
   - **Executes**: All processes in sequence
   - **Order**: Sync CSV ‚Üí Audit Scan ‚Üí Ranking & AI Scan ‚Üí Money Pages Scan ‚Üí Domain Strength ‚Üí Update All Tasks

### Data Update Processes

1. **Add Measurement** (`addMeasurementBtn` handler)
   - **Location**: Line ~13715
   - **Data Sources** (priority):
     1. GSC Page Totals API (URL-only tasks)
     2. `computeAiMetricsForPageUrl()` (URL tasks with AI data)
     3. Money Pages data
     4. `queryTotals` from localStorage/Supabase
   - **Stores**: Supabase `optimisation_measurements`

2. **Rebaseline** (`rebaselineBtn` handler)
   - **Location**: Task Details drawer
   - **Uses**: Same logic as Add Measurement
   - **Stores**: Supabase `optimisation_measurements` (baseline)

3. **Bulk Update All Tasks** (`bulkUpdateAllTasks()`)
   - **Location**: Line ~14498
   - **Uses**: Same logic as Add Measurement for each task
   - **Stores**: Supabase `optimisation_measurements` (multiple rows)

4. **Update Task Latest** (`updateTaskLatest()`)
   - **Location**: Line ~15478
   - **Uses**: Same logic as Add Measurement
   - **Stores**: Supabase `optimisation_measurements` (updates latest)

**Documentation**: `Docs/ALL-AUDIT-SCAN-PROCESSES.md` (detailed process documentation)

---

## All Fixes Status

### Fix 0: URL Task AI Citations Logic (CRITICAL)
**Status**: ‚è∏Ô∏è **AWAITING APPROVAL**  
**Priority**: üî¥ **CRITICAL**  
**Phase**: Phase 5 of Fix Plan

**Problem**: Current logic finds keywords where `best_url` matches target URL, then aggregates citations. This is WRONG.

**Solution**: Reverse logic - find keywords where `ai_alan_citations` array contains target URL.

**Affected Functions**:
- `computeAiMetricsForPageUrl()` - Core function
- Add Measurement button
- Rebaseline button
- Bulk Update All Tasks

**Documentation**: `Docs/URL-TASK-AI-CITATIONS-FIX-ANALYSIS.md`

---

### Fix 1: Make URL Matching Optional for Keyword Tasks
**Status**: ‚ùå **REVERTED** (was completed, lost in rollback)

**Problem**: Keyword tasks required URL match, causing failures when URL didn't match.

**Solution**: Made URL matching optional for keyword-based tasks.

**Was Implemented In**:
- `addMeasurementBtn` handler (line ~13797, ~13847)
- `updateTaskLatest()` function (line ~15509)
- `bulkUpdateAllTasks()` function

**Needs Re-implementation**: Yes, from clean baseline

---

### Fix 2: Unify "Add Measurement" and "Update Task Latest" Logic
**Status**: ‚ùå **REVERTED** (was partially complete, lost in rollback)

**Problem**: Different update processes use different logic.

**Solution**: Make all processes use same improved logic as "Bulk Update".

**Needs Re-implementation**: Yes, from clean baseline

---

### Fix 3: URL Task AI Data Matching
**Status**: ‚ùå **NOT WORKING** (superseded by Fix 0)

**Problem**: URL tasks not finding AI Overview/Citations even when data exists.

**Solution**: Enhanced `computeAiMetricsForPageUrl` with ultra-permissive matching.

**Status**: Multiple attempts made, still not working. Superseded by Fix 0 (correct logic).

---

### Fix 4: Standardize Data Source Priority
**Status**: ‚è∏Ô∏è **NOT STARTED**

**Problem**: Different processes check data sources in different order.

**Solution**: Create unified `getTaskMetricsFromDataSources()` function.

**Scope**: Major refactoring - create unified function, update all processes to use it.

**Deferred Until**: Fix 0 is resolved

---

### Fix 5: Ensure Data Freshness (Always Fetch Latest from Supabase)
**Status**: ‚ùå **REVERTED** (was completed, lost in rollback)

**Problem**: Processes used stale localStorage data instead of latest from Supabase.

**Solution**: Always fetch latest audit from Supabase before using cached data.

**Was Implemented In**:
- `addMeasurementBtn` handler
- `rebaselineBtn` handler

**Needs Re-implementation**: Yes, from clean baseline

---

## Technical Architecture

### Data Flow for URL Tasks

```
1. User clicks "Add Measurement" on URL task
   ‚Üì
2. addMeasurementBtn handler executes
   ‚Üì
3. Fetches latest audit from Supabase (Fix 5 - needs re-implementation)
   ‚Üì
4. Loads combinedRows from:
   - RankingAiModule.state().combinedRows
   - window.rankingAiData
   - localStorage.rankingAiData
   - Supabase audit_results.ranking_ai_data
   ‚Üì
5. Calls computeAiMetricsForPageUrl(pageUrl, combinedRows)
   ‚Üì
6. computeAiMetricsForPageUrl (Fix 0 - needs implementation):
   - CURRENT (WRONG): Finds keywords where best_url matches target URL
   - CORRECT: Finds keywords where ai_alan_citations array contains target URL
   - Counts unique keywords citing the URL
   - Returns { ai_overview: boolean, ai_citations: number }
   ‚Üì
7. If result is consistent, saves measurement
   ‚Üì
8. Updates UI with new measurement
```

### Key Functions

**`computeAiMetricsForPageUrl(pageUrl, rows)`** (line ~12700):
- **Purpose**: Find AI Overview and Citations for a given page URL
- **Input**: `pageUrl` (string), `rows` (array of combinedRows)
- **Output**: `{ ai_overview: boolean|null, ai_citations: number|null }`
- **Current Issue**: Using wrong logic (best_url matching instead of citations array)
- **Fix Needed**: Reverse logic to find keywords citing the URL (Fix 0)

**`normalizeUrl(url)`** (line ~12753):
- **Purpose**: Normalize URLs for comparison
- **Removes**: Protocol (http/https), www, query parameters, hash, trailing slash
- **Example**: `https://www.alanranger.com/photography-courses-coventry?srsltid=...` ‚Üí `alanranger.com/photography-courses-coventry`

**`populateMoneyPagesAiCitations(rows)`** (line ~30768):
- **Purpose**: Populate AI Citations column in Money Pages table
- **Current Issue**: Needs debouncing and execution guards (Phase 2)
- **Data Source**: localStorage cache ‚Üí Supabase API fallback

### Data Sources

**Supabase Tables**:
- `keyword_rankings`: Individual keyword rows with `best_url`, `has_ai_overview`, `ai_alan_citations_count`, `ai_alan_citations` (array)
- `audit_results`: Full audit snapshots with `ranking_ai_data` (JSONB containing `combinedRows`)
- `optimisation_tasks`: Task definitions
- `optimisation_measurements`: Task measurements over time
- `debug_logs`: Debug log entries (if saving enabled)

**Frontend Data Structures**:
- `combinedRows`: Array of `{ keyword, best_url, best_rank_group, has_ai_overview, ai_alan_citations_count, ai_alan_citations, ... }`
- `window.rankingAiData`: Same as `combinedRows`
- `RankingAiModule.state().combinedRows`: Same as `combinedRows`
- `localStorage.rankingAiData`: Cached `combinedRows` with timestamp

---

## Supabase Configuration

### Projects

**Primary Project** (`supabase-main`):
- Project Ref: `igzvwbvgvmzvvzoclufx`
- Contains: `keyword_rankings`, `audit_results`, `optimisation_tasks`, `optimisation_measurements`
- **This is the correct project to use**

**Secondary Project** (`supabase`):
- Project Ref: `dqrtcsvqsfgbqmnonkpt`
- **Do not use for queries** - may not have all tables

### MCP Tools (Model Context Protocol)

**‚ö†Ô∏è CRITICAL**: Always use `mcp_supabase-main_*` tools (NOT `mcp_supabase_*`)

**Correct Tools** (use these):
- `mcp_supabase-main_execute_sql`: Query database (read-only or read-write)
- `mcp_supabase-main_list_tables`: List all tables in database
- `mcp_supabase-main_apply_migration`: Apply database migrations
- `mcp_supabase-main_list_migrations`: List all migrations
- `mcp_supabase-main_list_extensions`: List database extensions
- `mcp_supabase-main_get_logs`: Get service logs (api, postgres, edge-function, auth, storage, realtime)
- `mcp_supabase-main_get_advisors`: Get security/performance advisories
- `mcp_supabase-main_generate_typescript_types`: Generate TypeScript types

**Wrong Tools** (do NOT use):
- `mcp_supabase_execute_sql` - Points to wrong project (dqrtcsvqsfgbqmnonkpt)
- `mcp_supabase_list_tables` - Points to wrong project

**How to Use**:
1. Always check which Supabase project you're querying
2. Use `mcp_supabase-main_*` prefix for all operations
3. Project ref `igzvwbvgvmzvvzoclufx` is the correct one
4. If you see `dqrtcsvqsfgbqmnonkpt` in results, you're using the wrong tools

**Example Queries**:
```javascript
// ‚úÖ CORRECT - Query keyword_rankings table
mcp_supabase-main_execute_sql({
  query: "SELECT keyword, best_url, ai_alan_citations_count FROM keyword_rankings WHERE property_url = 'https://www.alanranger.com' LIMIT 10"
})

// ‚úÖ CORRECT - List all tables
mcp_supabase-main_list_tables({ schemas: ["public"] })

// ‚ùå WRONG - Don't use this (wrong project)
mcp_supabase_execute_sql({ ... })
```

### Key Tables

**`keyword_rankings`**:
- Columns: `keyword`, `best_url`, `has_ai_overview`, `ai_alan_citations_count`, `ai_alan_citations` (array), `best_rank_group`, `property_url`, `audit_date`
- **Note**: `best_url` includes query parameters (e.g., `?srsltid=...`)
- **Note**: `ai_alan_citations` is an array of citation objects with `url`, `title`, `domain`

**`audit_results`**:
- Columns: `property_url`, `audit_date`, `ranking_ai_data` (JSONB)
- `ranking_ai_data.combinedRows`: Array of combinedRows

---

## Implementation Priorities

### Immediate (Post-Rollback)
1. **Phase 1**: Fix AI Citations column (remove sort icon, disable sorting)
2. **Phase 2**: Prevent flickering & reduce API calls (debounce, execution guards)
3. **Re-implement Fix 1**: Make URL matching optional for keyword tasks
4. **Re-implement Fix 5**: Always fetch latest from Supabase

### Short-term
5. **Phase 3**: Check & fix all update buttons (standardize logic)
6. **Phase 4**: Align all audit processes (consistent data source priority)
7. **Phase 5**: URL Task AI Citations Logic Fix (Fix 0 - critical)

### Medium-term
8. **Fix 4**: Standardize Data Source Priority (create unified function)
9. **Optimisation Tracking Phase 9**: Enhanced Analytics

### Long-term
10. Architecture roadmap items (Entity Extraction, Automation, Multi-Property)
11. README planned features (SERP monitoring, competitive analysis, etc.)

---

## Testing Checklist

### After Each Fix
- [ ] Test "Add Measurement" with URL tasks
- [ ] Test "Rebaseline" with URL tasks
- [ ] Test "Bulk Update All Tasks" with URL tasks
- [ ] Test "Update Task Latest" with URL tasks
- [ ] Verify AI Citations column displays correctly
- [ ] Verify no flickering in citation counts
- [ ] Verify all update buttons work correctly
- [ ] Verify end-to-end audit flow works

### Critical Test Cases
- [ ] URL task: `www.alanranger.com/photography-courses-coventry`
- [ ] Keyword task with matching URL
- [ ] Keyword task with non-matching URL
- [ ] Keyword task with no URL
- [ ] Money Pages table AI Citations column
- [ ] All update buttons in Optimisation Tracking

---

## Important Notes

### User Preferences
- **DO NOT use console.log**: User explicitly prefers UI debug log
- **DO NOT ask for console logs**: Use UI debug log or Supabase queries
- **DO NOT make assumptions**: Always verify with actual data/queries
- **DO NOT make changes without approval**: User wants diagnosis first, then fix plan, then approval

### Code Complexity
- **User Rule**: Never create code that goes beyond the 15 limit of complexity
- Keep functions simple and focused
- Break down complex logic into smaller functions

### Testing
- Always test with actual URL: `www.alanranger.com/photography-courses-coventry`
- Verify data exists in Supabase before assuming it's a matching issue
- Use MCP Supabase tools to query actual data
- Check UI debug log for diagnostic information

### Version Number
- **CRITICAL**: Update version number in `audit-dashboard.html` after each deployment
- Version number should reflect latest commit hash
- Prevents troubleshooting outdated versions

---

## Related Documentation Files

### Key MD Files (Reference Only - All Info Consolidated Above)
1. `Docs/UPDATE-TASKS-REFERENCE.md` - Complete update buttons reference (consolidated above)
2. `Docs/ALL-AUDIT-SCAN-PROCESSES.md` - All audit processes (consolidated above)
3. `Docs/FIX-PLAN-COMPREHENSIVE.md` - Comprehensive fix plan (consolidated above)
4. `Docs/URL-TASK-AI-CITATIONS-FIX-ANALYSIS.md` - Fix 0 detailed analysis
5. `Docs/MONEY_PAGES_PERFORMANCE.md` - Money Pages project plan (consolidated above)
6. `Docs/OPTIMISATION_TRACKING_MODULE_PLAN.md` - Optimisation Tracking project plan (consolidated above)
7. `Docs/OPTIMISATION_TRACKING_PHASES_COMPLETE.md` - Optimisation Tracking status (consolidated above)
8. `Docs/ARCHITECTURE.md` - System architecture and roadmap (consolidated above)
9. `README.md` - Project overview and features (stays in root)
10. `Docs/CHANGELOG.md` - Version history

**Note**: This HANDOVER.md is now the single source of truth. Other MD files are for reference only.

---

## Current State Summary

### What's Working ‚úÖ
- Money Pages Performance & Actions (100% complete)
- Optimisation Tracking Module (89% complete, Phases 1-8 done)
- Data Persistence (Supabase integration)
- Shareable Audit Links
- Stable AI citation counts in baseline (no flickering)
- AI Citations URL matching (fixed - strict path segment matching)
- AI Citations value preservation (fixed - cache trusted over API)

### What's Not Working ‚ùå
- AI Citations column sorting (still present, needs removal)
- URL Task AI Citations Logic (Fix 0 - wrong logic, needs reversal)

### What Needs Implementation ‚è∏Ô∏è
- Phase 1: AI Citations column fixes
- Phase 2: Prevent flickering & reduce API calls
- Phase 3: Check & fix all update buttons
- Phase 4: Align all audit processes
- Phase 5: URL Task AI Citations Logic Fix (Fix 0)
- Re-implement Fix 1 and Fix 5 (proven fixes)

---

## Contact & Context

**Project**: AI GEO Audit Dashboard  
**Location**: `g:\Dropbox\alan ranger photography\Website Code\AI GEO Audit`  
**Deployment**: Vercel (https://ai-geo-audit.vercel.app/)  
**Database**: Supabase (`supabase-main`, project_ref=igzvwbvgvmzvvzoclufx)

**Current Commit**: `2cb0a2a`  
**Baseline Commit**: `8951fcf`  
**Status**: Phase 3 fixes complete. Dashboard visualizations added. UI enhancements and bug fixes applied. Global run now automatically updates all tasks. Ready for Phase 4 (align all audit processes).

---

**End of Handover Document**
