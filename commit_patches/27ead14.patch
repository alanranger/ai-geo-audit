From 27ead142c81c67fa928ecb756f6845b65c838160 Mon Sep 17 00:00:00 2001
From: alanranger <info@alanranger.com>
Date: Tue, 23 Dec 2025 15:48:51 +0000
Subject: [PATCH] Fix Money Pages KPI Tracker: Use weekly bucketing like top
 charts, use date_end for GSC data period, fix dropdown selector

---
 audit-dashboard.html | 103 +++++++++++++++++++++++++++++--------------
 1 file changed, 69 insertions(+), 34 deletions(-)

diff --git a/audit-dashboard.html b/audit-dashboard.html
index 7930bbb..887c2b8 100644
--- a/audit-dashboard.html
+++ b/audit-dashboard.html
@@ -16087,20 +16087,44 @@ <h3>üîç Debug Log</h3>
           }
         }
         
-        // Get all unique dates and sort them
-        const allDates = new Set();
-        Object.values(segmentData).forEach(data => {
-          data.forEach(d => allDates.add(d.date.toISOString().split('T')[0]));
+        // Bucket data by week (Monday start) like the top charts
+        // Use date_end for the actual GSC data period, but bucket into weeks
+        const weeklyBuckets = new Map(); // key: Monday date (YYYY-MM-DD), value: Map<segment, {value, date_end}>
+        
+        segments.forEach(segment => {
+          segmentData[segment].forEach(d => {
+            // Calculate Monday of the week for this date_end
+            const dateEnd = new Date(d.date);
+            const dayOfWeek = dateEnd.getDay();
+            const diff = dateEnd.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
+            const monday = new Date(dateEnd);
+            monday.setDate(diff);
+            const mondayKey = monday.toISOString().split('T')[0];
+            
+            if (!weeklyBuckets.has(mondayKey)) {
+              weeklyBuckets.set(mondayKey, new Map());
+            }
+            
+            const bucket = weeklyBuckets.get(mondayKey);
+            // Keep the LAST snapshot in each week (by date_end)
+            if (!bucket.has(segment) || d.date > bucket.get(segment).date_end) {
+              bucket.set(segment, {
+                value: d.value,
+                date_end: d.date
+              });
+            }
+          });
         });
-        const sortedDates = Array.from(allDates).sort();
         
-        if (sortedDates.length === 0) {
+        // Get all unique week dates (Mondays) and sort them
+        const sortedWeekDates = Array.from(weeklyBuckets.keys()).sort();
+        
+        if (sortedWeekDates.length === 0) {
           debugLog('‚ö† No data found for Money Pages KPI Tracker', 'warn');
           return;
         }
         
-        debugLog(`üìä Money Pages KPI Tracker: Found ${sortedDates.length} unique dates: ${sortedDates.join(', ')}`, 'info');
-        debugLog(`üìä Money Pages KPI Tracker: Segment data counts - money: ${segmentData.money?.length || 0}, landing: ${segmentData.landing?.length || 0}, event: ${segmentData.event?.length || 0}, product: ${segmentData.product?.length || 0}`, 'info');
+        debugLog(`üìä Money Pages KPI Tracker: Found ${sortedWeekDates.length} weekly buckets: ${sortedWeekDates.join(', ')}`, 'info');
         
         // Build chart data
         const segmentLabels = {
@@ -16118,18 +16142,17 @@ <h3>üîç Debug Log</h3>
         };
         
         const chartData = {
-          labels: sortedDates.map(d => {
-            const date = new Date(d);
+          labels: sortedWeekDates.map(mondayStr => {
+            const date = new Date(mondayStr);
             return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
           }),
           datasets: segments.map(segment => {
-            const data = sortedDates.map(dateStr => {
-              const segmentPoint = segmentData[segment].find(d => 
-                d.date.toISOString().split('T')[0] === dateStr
-              );
-              const value = segmentPoint ? segmentPoint.value : null;
-              if (segmentPoint) {
-                debugLog(`üìä ${segmentLabels[segment]} (${segment}): ${dateStr} = ${value}`, 'info');
+            const data = sortedWeekDates.map(mondayStr => {
+              const bucket = weeklyBuckets.get(mondayStr);
+              const segmentData = bucket?.get(segment);
+              const value = segmentData ? segmentData.value : null;
+              if (segmentData) {
+                debugLog(`üìä ${segmentLabels[segment]} (${segment}): Week ${mondayStr} = ${value}`, 'info');
               }
               return value;
             });
@@ -16210,17 +16233,17 @@ <h3>üîç Debug Log</h3>
                     text: 'Month'
                   }
                 },
-                y: {
+              y: {
+                display: true,
+                title: {
                   display: true,
-                  title: {
-                    display: true,
-                    text: selectedMetric === 'avgPosition' ? 'Avg Position' :
-                          selectedMetric === 'ctr' ? 'CTR' :
-                          selectedMetric === 'impressions' ? 'Impressions' :
-                          'Clicks'
-                  }
+                  text: selectedMetric === 'avgPosition' ? 'Avg Position' :
+                        selectedMetric === 'ctr' ? 'CTR (%)' :
+                        selectedMetric === 'impressions' ? 'Impressions' :
+                        'Clicks'
                 }
               }
+              }
             }
           });
         }
@@ -16241,9 +16264,9 @@ <h3>üîç Debug Log</h3>
           segmentHeader.style.cssText = 'padding: 0.75rem; text-align: left; border-bottom: 2px solid #e2e8f0; background: #f1f5f9; font-weight: 600;';
           thead.appendChild(segmentHeader);
           
-          sortedDates.forEach(dateStr => {
+          sortedWeekDates.forEach(mondayStr => {
             const th = document.createElement('th');
-            const date = new Date(dateStr);
+            const date = new Date(mondayStr);
             th.textContent = date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
             th.style.cssText = 'padding: 0.75rem; text-align: center; border-bottom: 2px solid #e2e8f0; background: #f1f5f9; font-weight: 600;';
             thead.appendChild(th);
@@ -16264,12 +16287,11 @@ <h3>üîç Debug Log</h3>
             segmentCell.style.cssText = 'padding: 0.75rem; border-bottom: 1px solid #e2e8f0; font-weight: 600;';
             row.appendChild(segmentCell);
             
-            // Data cells
-            const values = sortedDates.map(dateStr => {
-              const segmentPoint = segmentData[segment].find(d => 
-                d.date.toISOString().split('T')[0] === dateStr
-              );
-              return segmentPoint ? segmentPoint.value : null;
+            // Data cells - use weekly buckets
+            const values = sortedWeekDates.map(mondayStr => {
+              const bucket = weeklyBuckets.get(mondayStr);
+              const segmentData = bucket?.get(segment);
+              return segmentData ? segmentData.value : null;
             });
             
             values.forEach((value, idx) => {
@@ -16322,6 +16344,11 @@ <h3>üîç Debug Log</h3>
         }
         
         debugLog('‚úì Money Pages KPI Tracker rendered', 'success');
+        
+        // Wire up metric selector after rendering
+        if (typeof window.wireMoneyKpiMetricSelector === 'function') {
+          window.wireMoneyKpiMetricSelector();
+        }
       } catch (err) {
         debugLog(`Error loading Money Pages KPI Tracker: ${err.message}`, 'error');
         console.error(err);
@@ -16334,12 +16361,20 @@ <h3>üîç Debug Log</h3>
     window.wireMoneyKpiMetricSelector = function() {
       const metricSelect = document.getElementById('money-kpi-metric-select');
       if (metricSelect) {
-        metricSelect.addEventListener('change', () => {
+        // Remove any existing listeners by cloning the element
+        const newSelect = metricSelect.cloneNode(true);
+        metricSelect.parentNode.replaceChild(newSelect, metricSelect);
+        
+        newSelect.addEventListener('change', () => {
           const propertyUrl = localStorage.getItem('gsc_property_url') || localStorage.getItem('last_property_url') || '';
           if (propertyUrl && typeof window.loadAuditHistoryAndRenderKpis === 'function') {
+            debugLog(`üìä Money KPI metric changed to: ${newSelect.value}`, 'info');
             window.loadAuditHistoryAndRenderKpis(propertyUrl);
           }
         });
+        debugLog('‚úì Money KPI metric selector wired up', 'success');
+      } else {
+        debugLog('‚ö† Money KPI metric selector not found', 'warn');
       }
     };
 
