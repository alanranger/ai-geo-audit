From cae92580db132f1eca458c1293e2d577d89f4853 Mon Sep 17 00:00:00 2001
From: alanranger <info@alanranger.com>
Date: Tue, 23 Dec 2025 15:12:13 +0000
Subject: [PATCH] Fix Money Pages KPI Tracker: Use new
 window.loadAuditHistoryAndRenderKpis function that fetches from
 portfolio_segment_metrics_28d instead of old audit history function

---
 audit-dashboard.html | 17 +++++++++--------
 1 file changed, 9 insertions(+), 8 deletions(-)

diff --git a/audit-dashboard.html b/audit-dashboard.html
index b064d8c..7930bbb 100644
--- a/audit-dashboard.html
+++ b/audit-dashboard.html
@@ -15120,7 +15120,7 @@ <h3>üîç Debug Log</h3>
             }
             
             const sparklineCanvas = document.getElementById('money-kpi-sparkline');
-            if (sparklineCanvas && typeof loadAuditHistoryAndRenderKpis === 'function') {
+            if (sparklineCanvas && typeof window.loadAuditHistoryAndRenderKpis === 'function') {
               const rect = sparklineCanvas.getBoundingClientRect();
               if (rect.width === 0 || rect.height === 0) {
                 debugLog('‚ö† Money KPI sparkline: Canvas has zero dimensions, will retry', 'warn');
@@ -15136,7 +15136,7 @@ <h3>üîç Debug Log</h3>
                     if (canvas) {
                       const rect = canvas.getBoundingClientRect();
                       if (rect.width > 0 && rect.height > 0) {
-                        loadAuditHistoryAndRenderKpis(propertyUrl);
+                        window.loadAuditHistoryAndRenderKpis(propertyUrl);
                       } else {
                         debugLog('‚ö† Money KPI sparkline: Canvas still has zero dimensions, retrying...', 'warn');
                         setTimeout(() => renderMoneyCharts(), 200);
@@ -18854,9 +18854,9 @@ <h3>üîç Debug Log</h3>
                 }
                 
                 // Refresh KPI tracker
-                if (typeof loadAuditHistoryAndRenderKpis === 'function') {
+                if (typeof window.loadAuditHistoryAndRenderKpis === 'function') {
                   setTimeout(() => {
-                    loadAuditHistoryAndRenderKpis(propertyUrl);
+                    window.loadAuditHistoryAndRenderKpis(propertyUrl);
                     debugLog('‚úì Money Pages KPI tracker refreshed', 'success');
                   }, 500);
                 }
@@ -31205,7 +31205,8 @@ <h3 style="margin: 0 0 1rem 0; font-size: 1.25rem; font-weight: 700; color: #1e2
        * Load audit history and render KPI tracker
        * @param {string} propertyUrl
        */
-      async function loadAuditHistoryAndRenderKpis(propertyUrl) {
+      // OLD FUNCTION - Using audit history (deprecated, use window.loadAuditHistoryAndRenderKpis instead)
+      async function loadAuditHistoryAndRenderKpis_OLD(propertyUrl) {
         if (!propertyUrl) return;
         
         const endDate = new Date().toISOString().split('T')[0];
@@ -31365,7 +31366,7 @@ <h3 style="margin: 0 0 1rem 0; font-size: 1.25rem; font-weight: 700; color: #1e2
             newSelect.addEventListener('change', () => {
               const propertyUrl = document.getElementById('propertyUrl')?.value;
               if (propertyUrl) {
-                loadAuditHistoryAndRenderKpis(propertyUrl);
+                window.loadAuditHistoryAndRenderKpis(propertyUrl);
               }
             });
             debugLog('‚úì Money KPI metric selector wired up', 'success');
@@ -32805,7 +32806,7 @@ <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem; font-weight: 700; color: #1e
         // Phase: Load and render 12-month KPI Tracker
         const propertyUrl = document.getElementById('propertyUrl')?.value || localStorage.getItem('gsc_property_url') || localStorage.getItem('last_property_url');
         if (propertyUrl) {
-          loadAuditHistoryAndRenderKpis(propertyUrl);
+          window.loadAuditHistoryAndRenderKpis(propertyUrl);
           
           // Wire up metric selector
           const metricSelect = document.getElementById('money-kpi-metric-select');
@@ -32816,7 +32817,7 @@ <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem; font-weight: 700; color: #1e
                 // Reload full history with timeseries when metric changes
                 const propertyUrl = document.getElementById('propertyUrl')?.value;
                 if (propertyUrl) {
-                  loadAuditHistoryAndRenderKpis(propertyUrl);
+                  window.loadAuditHistoryAndRenderKpis(propertyUrl);
                 } else {
                   // Fallback: use cached data but still need timeseries
                   debugLog('‚ö† Metric selector: No propertyUrl available, cannot reload timeseries', 'warn');
