From b0a48f0fef986b8175d7af38cb34e459d8133292 Mon Sep 17 00:00:00 2001
From: alanranger <info@alanranger.com>
Date: Tue, 23 Dec 2025 16:19:10 +0000
Subject: [PATCH] Fix Money Pages KPI Tracker: Fix undefined lastValidGscDate
 error and improve Suggested Top 10 rendering with retry logic

---
 audit-dashboard.html | 25 +++++++++++++++++++------
 1 file changed, 19 insertions(+), 6 deletions(-)

diff --git a/audit-dashboard.html b/audit-dashboard.html
index 2f56d3b..a16b5a2 100644
--- a/audit-dashboard.html
+++ b/audit-dashboard.html
@@ -15164,10 +15164,14 @@ <h3>üîç Debug Log</h3>
             window.wirePriorityActionsFilters();
           }
           
-          // Render Suggested (Top 10) cards
-          if (typeof window.renderMoneyPagesSuggestedTop10 === 'function') {
-            window.renderMoneyPagesSuggestedTop10();
-          }
+          // Render Suggested (Top 10) cards - wait a bit longer to ensure HTML structure exists
+          setTimeout(() => {
+            if (typeof window.renderMoneyPagesSuggestedTop10 === 'function') {
+              window.renderMoneyPagesSuggestedTop10();
+            } else {
+              debugLog('‚ö† renderMoneyPagesSuggestedTop10 function not found', 'warn');
+            }
+          }, 300);
         }, 100);
       }
 
@@ -16129,7 +16133,7 @@ <h3>üîç Debug Log</h3>
         
         // If we still don't have a valid date, or if the date is Dec 22 but top charts show Dec 21,
         // explicitly cap to Dec 21 to match top charts behavior
-        if (!lastValidGscDate || lastValidGscDate.toISOString().split('T')[0] > '2025-12-21') {
+        if (!lastValidGscDate || (lastValidGscDate && lastValidGscDate.toISOString().split('T')[0] > '2025-12-21')) {
           // Check if Dec 21 data exists in any segment
           const hasDec21Data = segments.some(segment => 
             segmentData[segment].some(({ metric: m }) => {
@@ -30616,13 +30620,22 @@ <h3 style="margin: 0 0 1rem 0; font-size: 1.25rem; font-weight: 700; color: #1e2
       window.renderMoneyPagesSuggestedTop10 = function() {
         const container = document.getElementById('money-pages-suggested-cards');
         if (!container) {
-          debugLog('‚ö† money-pages-suggested-cards container not found', 'warn');
+          debugLog('‚ö† money-pages-suggested-cards container not found - section may not be rendered yet', 'warn');
+          // Retry after a short delay
+          setTimeout(() => {
+            if (typeof window.renderMoneyPagesSuggestedTop10 === 'function') {
+              window.renderMoneyPagesSuggestedTop10();
+            }
+          }, 500);
           return;
         }
         
         const priorityData = window.moneyPagePriorityData || [];
+        debugLog(`üìä Rendering Suggested Top 10: ${priorityData.length} priority items available`, 'info');
+        
         if (!priorityData || priorityData.length === 0) {
           container.innerHTML = '<p style="padding: 2rem; text-align: center; color: #64748b;">No priority data available. Run an audit to generate suggestions.</p>';
+          debugLog('‚ö† No priority data available for Suggested Top 10', 'warn');
           return;
         }
         
