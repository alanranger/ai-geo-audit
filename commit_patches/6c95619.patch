From 6c956196a8a7c69c8f2672bd7c49d23dc2f70a81 Mon Sep 17 00:00:00 2001
From: alanranger <info@alanranger.com>
Date: Tue, 23 Dec 2025 16:38:28 +0000
Subject: [PATCH] Fix: Move renderMoneyPagesSuggestedTop10 to global scope
 early, fix all toISOString null checks in KPI tracker

---
 audit-dashboard.html | 93 +++++++++++++++++++++++++++++++++++++++++---
 1 file changed, 88 insertions(+), 5 deletions(-)

diff --git a/audit-dashboard.html b/audit-dashboard.html
index 3986565..bc1fab1 100644
--- a/audit-dashboard.html
+++ b/audit-dashboard.html
@@ -14982,6 +14982,88 @@ <h3>üîç Debug Log</h3>
         setTimeout(async () => {
           const saved = loadAuditResultsSync();
           
+          // Define renderMoneyPagesSuggestedTop10 at global scope early
+          if (!window.renderMoneyPagesSuggestedTop10) {
+            window.renderMoneyPagesSuggestedTop10 = function() {
+              const container = document.getElementById('money-pages-suggested-top10-container');
+              if (!container) {
+                debugLog('‚ö† money-pages-suggested-top10-container not found - section may not be rendered yet', 'warn');
+                setTimeout(() => {
+                  if (typeof window.renderMoneyPagesSuggestedTop10 === 'function') {
+                    window.renderMoneyPagesSuggestedTop10();
+                  }
+                }, 500);
+                return;
+              }
+              
+              const priorityData = window.moneyPagePriorityData || [];
+              debugLog(`üìä Rendering Suggested Top 10: ${priorityData.length} priority items available`, 'info');
+              
+              if (!priorityData || priorityData.length === 0) {
+                container.innerHTML = '<p style="padding: 2rem; text-align: center; color: #64748b;">No priority data available. Run an audit to generate suggestions.</p>';
+                debugLog('‚ö† No priority data available for Suggested Top 10', 'warn');
+                return;
+              }
+              
+              const top10 = [...priorityData]
+                .sort((a, b) => {
+                  const impactA = a.impactScore || 0;
+                  const impactB = b.impactScore || 0;
+                  if (impactB !== impactA) return impactB - impactA;
+                  const diffOrder = { LOW: 0, MEDIUM: 1, HIGH: 2 };
+                  return (diffOrder[a.difficultyLevel] || 2) - (diffOrder[b.difficultyLevel] || 2);
+                })
+                .slice(0, 10);
+              
+              if (top10.length === 0) {
+                container.innerHTML = '<p style="padding: 2rem; text-align: center; color: #64748b;">No suggestions available.</p>';
+                return;
+              }
+              
+              container.innerHTML = top10.map((page) => {
+                const isOptimized = page.optimisationStatus === 'on_page' || page.optimisationStatus === 'tracking';
+                const difficultyColors = { LOW: '#10b981', MEDIUM: '#f59e0b', HIGH: '#ef4444' };
+                const difficultyColor = difficultyColors[page.difficultyLevel] || '#64748b';
+                const impactScore = page.impactScore || 0;
+                
+                return `
+                  <div class="suggested-card" style="background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
+                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
+                      <div style="flex: 1;">
+                        <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem; font-weight: 700; color: #1e293b; line-height: 1.4;">${page.title || page.url || 'Untitled Page'}</h4>
+                        <a href="${page.url}" target="_blank" style="font-size: 0.85rem; color: #2563eb; text-decoration: none; word-break: break-all;">${page.url}</a>
+                      </div>
+                      ${isOptimized ? '<span style="padding: 0.25rem 0.75rem; background: #10b981; color: white; border-radius: 4px; font-size: 0.75rem; font-weight: 600; white-space: nowrap;">‚úì Being Optimised</span>' : ''}
+                    </div>
+                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
+                      <span style="padding: 0.25rem 0.5rem; background: #f1f5f9; border-radius: 4px; font-size: 0.75rem; color: #64748b; text-transform: uppercase;">${page.segmentType || 'landing'}</span>
+                      <span style="padding: 0.25rem 0.5rem; background: ${difficultyColor}20; color: ${difficultyColor}; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">${page.difficultyLevel || 'MED'}</span>
+                    </div>
+                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1rem; font-size: 0.85rem;">
+                      <div><div style="color: #64748b; margin-bottom: 0.25rem;">Pos:</div><div style="font-weight: 700; color: #1e293b;">${(page.avgPosition || 0).toFixed(1)}</div></div>
+                      <div><div style="color: #64748b; margin-bottom: 0.25rem;">CTR:</div><div style="font-weight: 700; color: #1e293b;">${((page.ctr || 0) * 100).toFixed(1)}%</div></div>
+                      <div><div style="color: #64748b; margin-bottom: 0.25rem;">Impr:</div><div style="font-weight: 700; color: #1e293b;">${(page.impressions || 0).toLocaleString()}</div></div>
+                      <div><div style="color: #64748b; margin-bottom: 0.25rem;">Upside:</div><div style="font-weight: 700; color: #1e293b;">${page.potentialClicks28d || 0}</div></div>
+                      <div><div style="color: #64748b; margin-bottom: 0.25rem;">Impact:</div><div style="font-weight: 700; color: #1e293b;">${Math.round(impactScore)}</div></div>
+                      <div><div style="color: #64748b; margin-bottom: 0.25rem;">Difficulty:</div><div style="font-weight: 700; color: ${difficultyColor};">${page.difficultyLevel || 'MED'}</div></div>
+                    </div>
+                    <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f8fafc; border-radius: 4px; font-size: 0.85rem; color: #475569;">
+                      <strong>Potential impact clicks 28d:</strong> ${page.potentialClicks28d || 0}
+                    </div>
+                    <div style="margin-bottom: 1rem; font-size: 0.85rem; color: #64748b; line-height: 1.5;">
+                      ${page.suggestion || (page.impactLevel === 'HIGH' && page.difficultyLevel === 'LOW' ? 'Improve relevance + internal links to lift rank' : 'Improve CTR (title/meta/snippet) + strengthen content')}
+                    </div>
+                    <button type="button" class="btn ${isOptimized ? 'btn-secondary' : 'btn-primary'}" onclick="${isOptimized ? `window.location.href='#optimisation'` : `window.createOptimisationTask('${page.url}', '', '${page.url}')`}" style="width: 100%; padding: 0.75rem; background: ${isOptimized ? '#64748b' : '#2563eb'}; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.875rem;">
+                      ${isOptimized ? 'Manage Task' : 'Create Task'}
+                    </button>
+                  </div>
+                `;
+              }).join('');
+              
+              debugLog(`‚úì Rendered ${top10.length} suggested top 10 cards`, 'success');
+            };
+          }
+          
           if (typeof renderMoneyPagesTable === 'function') {
             const priorityData = window.moneyPagePriorityData || (saved && saved.moneyPagePriorityData) || [];
             if (priorityData && priorityData.length > 0) {
@@ -16107,7 +16189,9 @@ <h3>üîç Debug Log</h3>
           
           if (completeDates.length > 0) {
             lastValidGscDate = completeDates[0];
-            debugLog(`üìÖ Using max complete date_end (appears in all ${segments.length} segments): ${lastValidGscDate.toISOString().split('T')[0]}`, 'info');
+            if (lastValidGscDate) {
+              debugLog(`üìÖ Using max complete date_end (appears in all ${segments.length} segments): ${lastValidGscDate.toISOString().split('T')[0]}`, 'info');
+            }
           } else {
             // If no date appears in all segments, use the most recent date that appears in at least 2 segments
             const partialDates = Array.from(dateCounts.entries())
@@ -16116,7 +16200,9 @@ <h3>üîç Debug Log</h3>
               .sort((a, b) => b - a);
             if (partialDates.length > 0) {
               lastValidGscDate = partialDates[0];
-              debugLog(`üìÖ Using max partial date_end (appears in at least 2 segments): ${lastValidGscDate.toISOString().split('T')[0]}`, 'info');
+              if (lastValidGscDate) {
+                debugLog(`üìÖ Using max partial date_end (appears in at least 2 segments): ${lastValidGscDate.toISOString().split('T')[0]}`, 'info');
+              }
             }
           }
         }
@@ -30626,9 +30712,6 @@ <h3 style="margin: 0 0 1rem 0; font-size: 1.25rem; font-weight: 700; color: #1e2
       
       // Make function globally available
       window.wirePriorityActionsFilters = wirePriorityActionsFilters;
-      
-      // Render Suggested (Top 10) cards - Define early so it's available when called
-      window.renderMoneyPagesSuggestedTop10 = function() {
         const container = document.getElementById('money-pages-suggested-top10-container');
         if (!container) {
           debugLog('‚ö† money-pages-suggested-top10-container not found - section may not be rendered yet', 'warn');
