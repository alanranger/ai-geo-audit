From 2c64d2a727dfc452067216d6ea245aa17643e169 Mon Sep 17 00:00:00 2001
From: alanranger <info@alanranger.com>
Date: Tue, 23 Dec 2025 14:54:38 +0000
Subject: [PATCH] Fix Money Pages KPI Tracker: Filter by date_end instead of
 created_at to show correct data periods

---
 audit-dashboard.html | 40 ++++++++++++++++++++++++++++++----------
 1 file changed, 30 insertions(+), 10 deletions(-)

diff --git a/audit-dashboard.html b/audit-dashboard.html
index 8d69404..86610d7 100644
--- a/audit-dashboard.html
+++ b/audit-dashboard.html
@@ -16022,11 +16022,15 @@ <h3>üîç Debug Log</h3>
         };
         const dbField = metricFieldMap[selectedMetric] || 'position_28d';
         
-        // Calculate date range (last 28 days)
+        // Calculate date range (last 28 days for date_end filtering)
         const toDate = new Date();
         const fromDate = new Date();
         fromDate.setDate(fromDate.getDate() - 28);
         
+        // Fetch a wider range (60 days) to ensure we get all records, then filter by date_end
+        const fetchFromDate = new Date();
+        fetchFromDate.setDate(fetchFromDate.getDate() - 60);
+        
         // Fetch data for all money page segments
         const segments = ['money', 'landing', 'event', 'product'];
         const segmentData = {};
@@ -16036,7 +16040,7 @@ <h3>üîç Debug Log</h3>
             siteUrl: propertyUrl,
             segment,
             scope: 'active_cycles_only',
-            from: fromDate.toISOString(),
+            from: fetchFromDate.toISOString(),
             to: toDate.toISOString(),
             order: 'asc'
           });
@@ -16044,15 +16048,31 @@ <h3>üîç Debug Log</h3>
           const response = await fetch(apiUrl(`/api/supabase/get-portfolio-segment-metrics?${params}`));
           if (response.ok) {
             const data = await response.json();
-            segmentData[segment] = (data.metrics || []).map(m => ({
-              date: m.date_end ? new Date(m.date_end) : new Date(m.created_at),
-              value: dbField === 'ctr_28d' ? parseFloat(m.ctr_28d || 0) :
-                     dbField === 'position_28d' ? (m.position_28d !== null && m.position_28d !== undefined && !isNaN(parseFloat(m.position_28d)) ? parseFloat(m.position_28d) : null) :
-                     dbField === 'clicks_28d' ? parseFloat(m.clicks_28d || 0) :
-                     dbField === 'impressions_28d' ? parseFloat(m.impressions_28d || 0) : null,
-              run_id: m.run_id
-            })).filter(d => d.value !== null && !isNaN(d.value));
+            segmentData[segment] = (data.metrics || []).map(m => {
+              // Use date_end for the date, fallback to created_at
+              const recordDate = m.date_end ? new Date(m.date_end) : new Date(m.created_at);
+              
+              // Filter by date_end: only include records where date_end is within the last 28 days
+              if (m.date_end) {
+                const dateEnd = new Date(m.date_end);
+                if (dateEnd < fromDate || dateEnd > toDate) {
+                  return null; // Exclude this record
+                }
+              }
+              
+              return {
+                date: recordDate,
+                value: dbField === 'ctr_28d' ? parseFloat(m.ctr_28d || 0) :
+                       dbField === 'position_28d' ? (m.position_28d !== null && m.position_28d !== undefined && !isNaN(parseFloat(m.position_28d)) ? parseFloat(m.position_28d) : null) :
+                       dbField === 'clicks_28d' ? parseFloat(m.clicks_28d || 0) :
+                       dbField === 'impressions_28d' ? parseFloat(m.impressions_28d || 0) : null,
+                run_id: m.run_id
+              };
+            }).filter(d => d !== null && d.value !== null && !isNaN(d.value));
+            
+            debugLog(`‚úì Fetched ${segmentData[segment].length} records for segment '${segment}' (filtered by date_end in last 28 days)`, 'info');
           } else {
+            debugLog(`‚ö† Failed to fetch data for segment '${segment}': ${response.status}`, 'warn');
             segmentData[segment] = [];
           }
         }
