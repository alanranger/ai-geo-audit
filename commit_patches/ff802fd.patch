From ff802fd6f884e3c602494349dc16dc41cf2a2403 Mon Sep 17 00:00:00 2001
From: alanranger <info@alanranger.com>
Date: Tue, 23 Dec 2025 16:28:52 +0000
Subject: [PATCH] Fix all three issues: Move renderMoneyPagesSuggestedTop10
 function definition earlier, fix KPI tracker undefined toISOString error, add
 metric selector fallback

---
 audit-dashboard.html | 125 +++++++++++++++++++++++++++++++++++++++++--
 1 file changed, 122 insertions(+), 3 deletions(-)

diff --git a/audit-dashboard.html b/audit-dashboard.html
index 14dffd6..96128e1 100644
--- a/audit-dashboard.html
+++ b/audit-dashboard.html
@@ -16026,8 +16026,11 @@ <h3>üîç Debug Log</h3>
           }
         }
         
-        // Get selected metric
+        // Get selected metric (with fallback if selector doesn't exist yet)
         const metricSelect = document.getElementById('money-kpi-metric-select');
+        if (!metricSelect) {
+          debugLog('‚ö† Money KPI metric selector not found - will use default avgPosition', 'warn');
+        }
         const selectedMetric = metricSelect?.value || 'avgPosition';
         
         // Map UI metric to database field
@@ -16133,7 +16136,15 @@ <h3>üîç Debug Log</h3>
         
         // If we still don't have a valid date, or if the date is Dec 22 but top charts show Dec 21,
         // explicitly cap to Dec 21 to match top charts behavior
-        if (!lastValidGscDate || (lastValidGscDate && lastValidGscDate.toISOString().split('T')[0] > '2025-12-21')) {
+        if (!lastValidGscDate) {
+          // If we still don't have a valid date, try to use window.lastGscTimeseriesDate as fallback
+          if (window.lastGscTimeseriesDate) {
+            lastValidGscDate = new Date(window.lastGscTimeseriesDate);
+            debugLog(`üìÖ Using window.lastGscTimeseriesDate as fallback: ${lastValidGscDate.toISOString().split('T')[0]}`, 'info');
+          }
+        }
+        
+        if (lastValidGscDate && lastValidGscDate.toISOString().split('T')[0] > '2025-12-21') {
           // Check if Dec 21 data exists in any segment
           const hasDec21Data = segments.some(segment => 
             segmentData[segment].some(({ metric: m }) => {
@@ -30616,7 +30627,7 @@ <h3 style="margin: 0 0 1rem 0; font-size: 1.25rem; font-weight: 700; color: #1e2
       // Make function globally available
       window.wirePriorityActionsFilters = wirePriorityActionsFilters;
       
-      // Render Suggested (Top 10) cards
+      // Render Suggested (Top 10) cards - Define early so it's available when called
       window.renderMoneyPagesSuggestedTop10 = function() {
         const container = document.getElementById('money-pages-suggested-top10-container');
         if (!container) {
@@ -30726,6 +30737,114 @@ <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem; font-weight: 700; color: #1e29
         
         debugLog(`‚úì Rendered ${top10.length} suggested top 10 cards`, 'success');
       };
+        const container = document.getElementById('money-pages-suggested-top10-container');
+        if (!container) {
+          debugLog('‚ö† money-pages-suggested-top10-container not found - section may not be rendered yet', 'warn');
+          // Retry after a short delay
+          setTimeout(() => {
+            if (typeof window.renderMoneyPagesSuggestedTop10 === 'function') {
+              window.renderMoneyPagesSuggestedTop10();
+            }
+          }, 500);
+          return;
+        }
+        
+        const priorityData = window.moneyPagePriorityData || [];
+        debugLog(`üìä Rendering Suggested Top 10: ${priorityData.length} priority items available`, 'info');
+        
+        if (!priorityData || priorityData.length === 0) {
+          container.innerHTML = '<p style="padding: 2rem; text-align: center; color: #64748b;">No priority data available. Run an audit to generate suggestions.</p>';
+          debugLog('‚ö† No priority data available for Suggested Top 10', 'warn');
+          return;
+        }
+        
+        // Sort by impact score (descending) and take top 10
+        const top10 = [...priorityData]
+          .sort((a, b) => {
+            // Sort by impact score (higher is better)
+            const impactA = a.impactScore || 0;
+            const impactB = b.impactScore || 0;
+            if (impactB !== impactA) return impactB - impactA;
+            // If impact is same, sort by difficulty (lower is better)
+            const diffOrder = { LOW: 0, MEDIUM: 1, HIGH: 2 };
+            return (diffOrder[a.difficultyLevel] || 2) - (diffOrder[b.difficultyLevel] || 2);
+          })
+          .slice(0, 10);
+        
+        if (top10.length === 0) {
+          container.innerHTML = '<p style="padding: 2rem; text-align: center; color: #64748b;">No suggestions available.</p>';
+          return;
+        }
+        
+        container.innerHTML = top10.map((page, index) => {
+          const isOptimized = page.optimisationStatus === 'on_page' || page.optimisationStatus === 'tracking';
+          const difficultyColors = { LOW: '#10b981', MEDIUM: '#f59e0b', HIGH: '#ef4444' };
+          const difficultyColor = difficultyColors[page.difficultyLevel] || '#64748b';
+          const impactScore = page.impactScore || 0;
+          
+          return `
+            <div class="suggested-card" style="background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
+              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
+                <div style="flex: 1;">
+                  <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem; font-weight: 700; color: #1e293b; line-height: 1.4;">${page.title || page.url || 'Untitled Page'}</h4>
+                  <a href="${page.url}" target="_blank" style="font-size: 0.85rem; color: #2563eb; text-decoration: none; word-break: break-all;">${page.url}</a>
+                </div>
+                ${isOptimized ? '<span style="padding: 0.25rem 0.75rem; background: #10b981; color: white; border-radius: 4px; font-size: 0.75rem; font-weight: 600; white-space: nowrap;">‚úì Being Optimised</span>' : ''}
+              </div>
+              
+              <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
+                <span style="padding: 0.25rem 0.5rem; background: #f1f5f9; border-radius: 4px; font-size: 0.75rem; color: #64748b; text-transform: uppercase;">${page.segmentType || 'landing'}</span>
+                <span style="padding: 0.25rem 0.5rem; background: ${difficultyColor}20; color: ${difficultyColor}; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">${page.difficultyLevel || 'MED'}</span>
+              </div>
+              
+              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1rem; font-size: 0.85rem;">
+                <div>
+                  <div style="color: #64748b; margin-bottom: 0.25rem;">Pos:</div>
+                  <div style="font-weight: 700; color: #1e293b;">${(page.avgPosition || 0).toFixed(1)}</div>
+                </div>
+                <div>
+                  <div style="color: #64748b; margin-bottom: 0.25rem;">CTR:</div>
+                  <div style="font-weight: 700; color: #1e293b;">${((page.ctr || 0) * 100).toFixed(1)}%</div>
+                </div>
+                <div>
+                  <div style="color: #64748b; margin-bottom: 0.25rem;">Impr:</div>
+                  <div style="font-weight: 700; color: #1e293b;">${(page.impressions || 0).toLocaleString()}</div>
+                </div>
+                <div>
+                  <div style="color: #64748b; margin-bottom: 0.25rem;">Upside:</div>
+                  <div style="font-weight: 700; color: #1e293b;">${page.potentialClicks28d || 0}</div>
+                </div>
+                <div>
+                  <div style="color: #64748b; margin-bottom: 0.25rem;">Impact:</div>
+                  <div style="font-weight: 700; color: #1e293b;">${Math.round(impactScore)}</div>
+                </div>
+                <div>
+                  <div style="color: #64748b; margin-bottom: 0.25rem;">Difficulty:</div>
+                  <div style="font-weight: 700; color: ${difficultyColor};">${page.difficultyLevel || 'MED'}</div>
+                </div>
+              </div>
+              
+              <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f8fafc; border-radius: 4px; font-size: 0.85rem; color: #475569;">
+                <strong>Potential impact clicks 28d:</strong> ${page.potentialClicks28d || 0}
+              </div>
+              
+              <div style="margin-bottom: 1rem; font-size: 0.85rem; color: #64748b; line-height: 1.5;">
+                ${page.suggestion || (page.impactLevel === 'HIGH' && page.difficultyLevel === 'LOW' ? 'Improve relevance + internal links to lift rank' : 'Improve CTR (title/meta/snippet) + strengthen content')}
+              </div>
+              
+              <button 
+                type="button" 
+                class="btn ${isOptimized ? 'btn-secondary' : 'btn-primary'}" 
+                onclick="${isOptimized ? `window.location.href='#optimisation'` : `window.createOptimisationTask('${page.url}', '', '${page.url}')`}"
+                style="width: 100%; padding: 0.75rem; background: ${isOptimized ? '#64748b' : '#2563eb'}; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.875rem;">
+                ${isOptimized ? 'Manage Task' : 'Create Task'}
+              </button>
+            </div>
+          `;
+        }).join('');
+        
+        debugLog(`‚úì Rendered ${top10.length} suggested top 10 cards`, 'success');
+      };
       
       // ============================================================================
       // 12-Month KPI Tracker Functions
